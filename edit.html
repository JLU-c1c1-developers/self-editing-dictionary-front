<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<link rel="stylesheet" href="css/edit.css" />
		<link rel="icon" href="img/猫爪.png">
	</head>
	<body  background="./img/cat.jpeg" style="background-repeat: no-repeat;background-size: 100% 100%">
		
		<div class="hmask" style="display: none;">
			<div class="hmask-confirm">
				<div class="cross">
					X
				</div>
				<div class="tips tips-help">
					<p>网页帮助：本网页是一个在线的单词查询以及积累平台，具有查询单词，构建词典（即积累单词），以及与他人互享词典等功能。在基于日常生活常用单词的范围与频率下，通过满足对日常单词的查询，积累的需求，实现对日常单词的巩固积累，从而提高自身特定语境下的英语交流能力，从而满足日常生活的需求。
						本王网页由宣传界面，登录、注册界面，词典界面，以及个人主页构成。下面将对其涉及理念及功能进行说明：</p>
					<p>一，注册，登录界面</p>
					<p>1．页面说明</p>
						<p>（1）登录，注册界面分别完成用户的登录，注册功能，同时支持对分享词典的阅读查看</p>
					<p>2．页面帮助</p>
						<p>（1）登录：登录时按照提示，输入已注册用户正确的的电话，密码，点击登录即可，登录后跳转词典界面，若为注册本账户，可通过注册页先完成注册</p>
						<p>（2）注册：注册时，按照提示，输入电话，昵称，密码，并确认密码，即可完成注册。</p>
					<p>二，词典界面</p>
					<p>1．页面说明</p>
						<p>（1）词典界面即网页的主页面，可以在此检索词典，查看他人的词典，同时，也有机会中此看到自己的分享的词典。</p>
					<p>2．页面帮助</p>
						<p>（1）词典检索：本词典主要支持通过词典名称，作者名称以及二者结合的方式进行检索</p>
						<p>（2）词典查看：通过点击词典主体实现对词典的查看。</p>
					<p>三，个人主页</p>
						<p>1．页面说明</p>
						<p>（1）个人主页主要包括个人资料，我的词典，以及新建词典三个板块</p>
						<p>2．页面帮助</p>
						<p>（1）个人资料：通过点击个人资料进入个人资料页面，可以查看个人资料。通过页面下方的修改按钮，还能实现对个人资料的修改</p>
						<p>（2）我的词典：通过点击我的词典进入我的词典页面，我的词典页面收藏了所有自己创建的词典，可以通过点击词典主体对词典进行浏览，点击下方的删除实现对词典的删除。</p>
						<p>（3）新建词典：通过点击新建词典进入新建词典页面，按照提示，输入词典名字，词典继承，点击页面下方的新建词典按钮即可实现词典的建立。</p>
					<p>--附：本网页由：李唯聪，陈哲楷，刘俊宏，陈园共同完成。由于时间匆忙，网页尚有很多不足的地方，欢迎各位发现反馈，予以指正。</p>
				</div>
				<button class="submit submit-help">确认</button>
			</div>
		</div>

		<div class="mask" style="display: none;">
			<div class="mask-confirm">
				<div class="cross">
					X
				</div>
				<div class="tips tips-public">
					<p>--点击下方“发布词典”按钮将会公开此词典。公开词典需要词典包含多于10个词汇。</p>
					<p>--公开后，本词典将被允许其他用户检索查看，提供学习交流使用，帮助词友的同时也可使词典内容在其他词友的建议下更加完善；</p>
					<p>--公开后，你可以在词典界面通过词典检索功能检索到自己的词典，同时，优秀的词典也将有机会放于首页面，作为推荐词典。</p>
					<p>--公开后，在编辑词典页面通过“撤回词典”即可将词典变回私有，同时可以再次公开词典。</p>
				</div>
				<div class="tips tips-private">
					<p>--点击下方“撤回词典”按钮将会撤回此公开词典。当词汇不多于10个时，词典将会自动修改为未公开状态</p>
					<p>--撤回后，本词典将会从首页推荐删除，并且不可被其他用户检索查看，仅供自己查看与编辑。</p>
					<p>--通过词典编辑页面左侧的“公开词典”按钮可再次将此词典公开。</p>
				</div>
				<button class="submit submit-public">发布词典</button>
				<button class="submit submit-private">撤回词典</button>
			</div>
		</div>
		
		<div class="wrapper">
			<div class="first-line">
				<a class="first-line-back" style="background:url(img/logo.png) no-repeat;background-size: 70%;border-bottom: 1px solid;background-position: 1.5rem 1rem;" href="index.html"></a>
				<div class="first-line-options">
					<button class="first-line-option option-all">所有词典</button>
					<button class="first-line-option option-help">词典帮助</button>
					<div class="option-space"></div>
					<button class="first-line-option option-dict">浏览模式</button>
					<button class="first-line-option option-info">修改词典</button>
					<button class="first-line-option option-public">公开词典</button>
					<div class="option-space"></div>
					<button class="first-line-option option-homepage" style="display: none;">个人主页</button>
					<button class="first-line-option option-logout" style="display: none;">退出登录</button>
				</div>
			</div>
			<div class="second-line">
				<div class="second-line-admin" >
					<div class="second-line-admin-pic"></div>
					<p class="second-line-admin-name">admin</p>
				
				</div>

			</div>
			<div class="message">
				<div class="message-title">
					<h2 class="message-title-content">《实用工具-自编辑辞典v1.0》</h2>
					<h4 class="message-title-content">--吉林大学2119级网页设计小组LCLC开发--</h4>
				</div>
			</div>
			<div class ="book">
				<div class="book-info">
					<table border="2" class="book-info-sheet book-info-show">
						<tr>
							<td colspan="2" class="book-info-name"></td>
							<td rowspan="2" class="book-info-introduction" width="64%"></td>
							<td rowspan="2" width="6%" class="book-info-delete"><button>删除词典</button></td>
						</tr>
						<tr>
							<td class="book-info-private"></td>
							<td class="book-info-wordcount"></td>
						</tr>
					</table> 
					<table border="1" class="book-info-sheet book-info-input" style="display: none;">
						<tr>
							<td colspan="2" class="book-info-name"><input type="text" value=""></td>
							<td rowspan="2" class="book-info-introduction" width="64%"><textarea></textarea></td>
							<td rowspan="2" class="book-info-submit" width="6%"><button>确认修改</button></td>
						</tr>
						<tr>
							<td class="book-info-private"></td>
							<td class="book-info-wordcount"></td>
						</tr>
					</table> 
				</div>
				<p style="width: 100%; height: .2rem; background: rgb(18, 0, 121);margin: .2rem 0rem;"></p>
				<ul class="result" style="display: none;"></ul>
				<div class="words-input">
				    <input type="text" class="words-input-english words-input-retrieval" placeholder="单词或词组"/>
				    <input type="text" class="words-input-short" placeholder="缩写或标注"/>
				    <input type="text" class="words-input-china words-input-retrieval" placeholder="释义"/>
				    <button class="words-input-new">添加词汇</button>
				</div>
				<p style="width: 100%; height: .2rem; background: rgb(18, 0, 121);margin: .2rem 0rem;"></p>
				<div class="book-wrapper" id="sheet-words">
					
				</div>
				
			</div>
		</div>
	</body>
</html>
<script>
	function toPage(href,flag = false){
		document.location.href = href + (flag ? '?bId=' + document.location.href.split('?')[1].split('=')[1] : '');
	}
</script>
<script src="commen.js"></script>
<script src="jquery-3.5.1.js"></script>
<script>
	
	//删除词典事件
	$('.book-info-delete').click(function(){
		if(!confirm('确认删除词典？')){
			return;
		}
		$.ajax({
			url:'http://60.205.211.19:2119/bill/delete',
			headers:{
				Authorization:sessionStorage.getItem('token')
			},
			xhrFields:{
				withCredentials:true
			},
			data:{
				bId:document.location.href.split('?')[1].split('=')[1]
			},
			success:function(res){
				if(res.code == 200){
					alert('删除成功');
					location.href = 'home.html';
				}else{
					alert('删除失败:' + res.message);
				}
			}
		})
	})
	
	//所有词典——回到主页
	$('.option-all').click(function(){
		location.href = 'index.html';
	})
	
	//个人主页
	$('.option-homepage').click(function(){
		location.href = 'home.html';
	})
	
	//处理登出事件
	$('.option-logout').click(function(){
		$.ajax({
			url:'http://60.205.211.19:2119/user/logout',
			headers:{
				Authorization:sessionStorage.getItem('token')
			},
			xhrFields:{
				withCredentials:true
			},
			success:function(res){
				if(res.code == 200){
					alert('登出成功');
					sessionStorage.removeItem('token');
					location.reload();
				}
			}
		})
	})
	
	//处理浏览模式事件
	$('.option-dict').click(function(){
		location.href='dict.html?bId=' + document.location.href.split('?')[1].split('=')[1];
	})
	
	//处理词典信息修改事件
	$('.book-info-submit>button').click(function(){
		$.ajax({
			url:'http://60.205.211.19:2119/bill/update',
			headers:{
				Authorization:sessionStorage.getItem('token')
			},
			xhrFields:{
				withCredentials:true
			},
			type:'post',
			data:{
				bId:document.location.href.split('?')[1].split('=')[1],
				name:$('.book-info-name>input').val(),
				introduction:$('.book-info-introduction>textarea').val()
			},
			success:function(res){
				if(res.code == 200){
					alert('修改成功！');
					getWordList();
					$('.option-info').click();
				}else{
					alert('修改失败：' + res.message);
				}
			}
		})
	})
	
	//修改词典信息事件
	$('.option-info').click(function(){
		if($('.book-info-show').is(':hidden')){
			$('.book-info-show').show();
			$('.book-info-input').hide();
		}else{
			$('.book-info-name>input').val(bill.name);
			$('.book-info-introduction>textarea').val(bill.introduction);
			
			$('.book-info-show').hide();
			$('.book-info-input').show();
		}
	})
	
	//公开词典点击事件
	$('.option-public').click(function(){
		// alert(123);
		$('.mask').fadeIn(200);
		
		//隐藏组件
		$('.hmask-confirm>.tips').hide();
		$('.hmask-confirm>.submit').hide();
		$('.mask-confirm>.tips').hide();
		$('.mask-confirm>.submit').hide();
		
		
		//显示对应组件
		if(bill.private){
			$('.tips-public').show();
			$('.submit-public').show();
		}else{
			$('.tips-private').show();
			$('.submit-private').show();
		}
	})
	
	//词典帮助点击事件
	$('.option-help').click(function(){
		// alert(123);
		$('.hmask').fadeIn(200);
		
		//隐藏组件
		$('.mask-confirm>.tips').hide();
		$('.mask-confirm>.submit').hide();
		$('.hmask-confirm>.tips').hide();
		$('.hmask-confirm>.submit').hide();
		
		//显示对应组件
		$('.tips-help').show();
		$('.submit-help').show();
	})

	//关闭词典帮助点击事件
	$('.cross').click(function(){
		// alert(123);
		$('.hmask').fadeOut(200);
		
		//隐藏组件
		$('.hmask-confirm>.tips').hide();
		$('.hmask-confirm>.submit').hide();
		
		//显示对应组件
		$('.tips-help').hide();
		$('.submit-help').hide();
	})

	//确认词典帮助点击事件
	$('.submit-help').click(function(){
		// alert(123);
		$('.hmask').fadeOut(200);
		
		//隐藏组件
		$('.hmask-confirm>.tips').hide();
		$('.hmask-confirm>.submit').hide();
		
		//显示对应组件
		$('.tips-help').hide();
		$('.submit-help').hide();
	})
	
	//公开词典确认点击事件
	$('.mask-confirm>.cross').click(function(){
		$('.mask').fadeOut(200);
	})
	
	//公开词典提交事件
	$('.submit-public').click(function(){
		$.ajax({
			url:'http://60.205.211.19:2119/bill/publicBill',
			type:'GET',
			headers:{
				Authorization:sessionStorage.getItem('token')
			},
			xhrFields:{
				withCredentials:true
			},
			data:{
				bId:document.location.href.split('?')[1].split('=')[1],
				isPrivate:false
			},
			success:function(res){
				if(res.code == 200){
					alert('词典发布成功!!!');
					location.reload();
				}else{
					alert('词典发布失败：' + res.message);
				}
			}
		})
	})
	
	//撤回词典提交事件
	$('.submit-private').click(function(){
		$.ajax({
			url:'http://60.205.211.19:2119/bill/publicBill',
			type:'GET',
			headers:{
				Authorization:sessionStorage.getItem('token')
			},
			xhrFields:{
				withCredentials:true
			},
			data:{
				bId:document.location.href.split('?')[1].split('=')[1],
				isPrivate:true
			},
			success:function(res){
				if(res.code == 200){
					alert('词典成功撤回');
					location.reload()
				}else{
					alert('词典撤回失败：' + res.message);
				}
			}
		})
	})
	
	$('.words-input-retrieval').on('focus',function(){
		if($(this).val() == ''){
			return;
		}
		$('.result').slideDown(300);
	})
	
	$('.words-input-retrieval').on('blur',function(){
		$('.result').fadeOut(300);
	})
	
	function selectWord(word){
		
		let eng = word.split('/;/')[0];
		let cn = word.split('/;/')[1];
		$('.words-input-english').val(eng);
		$('.words-input-china').val(cn);
		$('.result').empty().hide();
		
	}
	
	//当前被选择的单词
	var currResult = -1;
	
	//检索单词结果集合大小
	var resultSize = 0;
	
	//清除对展示框单词的选择
	function cleanListSelect(){
		$('.result-node').removeClass('result-node-selected');
	}
	
	//选择特定的单词
	function selectListNode(idx){
		if(idx < 0){
			return;
		}
		$('.result-node-' + idx).addClass('result-node-selected');
	}
	
	//英文输入检索
	$('.words-input-english').on('input',function(){
		if($(this).val() == ''){
			$('.result').empty();
			$('.result').fadeOut(300);
			return;
		}
		$('.result').slideDown(300);
		var that = this;
		$.ajax({
			url:'http://60.205.211.19:2119/dict/searchByPrefix',
			type:'GET',
			data:{
				eng:$(this).val()
			},
			success:function(res){
				if(res.message != $(that).val()){
					return;
				}
				
				let data = res.data;
				$('.result').empty();
				let w = $(that).val();
				for(let i = 0;i < data.length;i++){
					let eng = $('<span>' + data[i].eng.replace(w,'<em>' + w + '</em>') + '</span>');
					let cn = $('<span>' + data[i].cn + '</span>');
					let li = $('<li onclick="selectWord(\'' + data[i].eng  + '/;/' + data[i].cn + '\')"></li>')
					li.append(eng);
					li.append(cn);
					li.addClass('result-node');
					li.addClass('result-node-' + i);
					$('.result').append(li);
				}
				
				currResult = -1;
				resultSize = data.length;
			}
		})
	})
	
	//中文输入检索
	$('.words-input-china').on('input',function(){
		if($(this).val() == ''){
			$('.result').empty();
			$('.result').fadeOut(300);
			return;
		}
		$('.result').slideDown(300);
		var that = this;
		$.ajax({
			url:'http://60.205.211.19:2119/dict/searchByCn',
			type:'GET',
			data:{
				cn:$(this).val()
			},
			success:function(res){
				if(res.message != $(that).val()){
					return;
				}
				
				let data = res.data;
				$('.result').empty();
				let w = $(that).val();
				for(let i = 0;i < data.length;i++){
					let eng = $('<span>' + data[i].eng + '</span>');
					let cn = $('<span>' + data[i].cn.replace(w,'<em>' + w + '</em>') + '</span>');
					let li = $('<li onclick="selectWord(\'' + data[i].eng  + '/;/' + data[i].cn + '\')"></li>')
					li.append(eng);
					li.append(cn);
					li.addClass('result-node');
					li.addClass('result-node-' + i);
					$('.result').append(li);
				}
				
				currResult = -1;
				resultSize = data.length;
			}
		})
	})
	
	//添加单词
	var words_new = function(english="暂无单词或词组", short="暂无缩写", china="暂无单词释义"){
		
		var div = document.createElement("div");
		div.setAttribute("class", "words-output");
		div.setAttribute("id", "sheet" + index_num);
	
		var p1 = document.createElement("p");
		p1.setAttribute("class", "words-output-english");
		p1.setAttribute('title',english);
		p1.innerHTML = english;
	
		var p2 = document.createElement("p");
		p2.setAttribute("class", "words-output-short");
		p2.setAttribute('title',short)
		p2.innerHTML = short;
		
		var p3 = document.createElement("p");
		p3.setAttribute("class", "words-output-china");
		p3.setAttribute('title',china);
		p3.innerHTML = china;
	
		var p0 = document.createElement("p");
		p0.setAttribute("class", "words-output-delete");
		p0.setAttribute("id", index_num++);
		p0.innerHTML = "删除";
	
		div.append(p0);
		div.append(p1);
		div.append(p2);
		div.append(p3);
		console.log(index_num);
	
		$("#sheet-words").append(div);
	}
	
	//放置词典信息
	function displayBillInfo(){
		// alert($('.book-info-show .book-info-name').text())
		$('.book-info-show .book-info-name').text('《' + bill.name + '》');
		$('.book-info-private').text(bill.private ? '未公开' : '已公开');
		$('.book-info-wordcount').text(bill.wordCount);
		$('.book-info-show .book-info-introduction').text(bill.introduction);
		$('.option-public').text(bill.private ? '发布词典' : '撤销发布');
	}
	
	function getWordList(){
		let bId = document.location.href.split('?')[1].split('=')[1];
		console.log('当前页面单词集id为:' + bId);
		
		$.ajax({
			url:'http://60.205.211.19:2119/bill/getWithWord',
			type:'GET',
			data:{
				bId:bId
			},
			headers:{
				Authorization:sessionStorage.getItem('token')
			},
			xhrFields:{
				withCredentials:true
			},
			success:function(res){
				
				console.log(res);
				$('.words-output').remove();
				
				$('title').text('《' + res.data.name + '》');
				
				bill = res.data;
				index_num = 0;
				
				displayBillInfo();
				
				let data = res.data.words;
				for(let i = 0;i < data.length;i++){
					words_new(data[i].eng,data[i].shrt,data[i].cn,data[i].id);
				}
			}
		})
	}
	
	getWordList();
	
	var index_num = 0;
	
	var bill;
	
	//输入框按键按下事件
	$('.words-input-retrieval').keydown(function(e){
		if(e.keyCode == 13){//回车键
			if(currResult >= 0){
				$('.result-node-selected').click()
				currResult = -1;
			}else{
				$('.words-input-new').click();
			}
		}else if(e.keyCode == 40){//下
			// console.log(e.key);
			currResult++;
			currResult %= resultSize;
			cleanListSelect();
			selectListNode(currResult);
			
		}else if(e.keyCode == 38){//上
			// console.log(e.key);
			
			currResult--;
			currResult += resultSize;
			currResult %= resultSize;
			cleanListSelect();
			selectListNode(currResult);
		}
	})
	
	//添加单词事件
	$(".words-input-new").click(function(){
	    
	    var english = $(".words-input-english").val()
	    var short = $(".words-input-short").val()
	    var china = $(".words-input-china").val()
	
		if(short == ''){
			short = '无';
		}
		
		$.ajax({
			url:'http://60.205.211.19:2119/word/add',
			type:'POST',
			headers:{
				Authorization:sessionStorage.getItem('token')
			},
			xhrFields:{
				withCredentials:true
			},
			data:{
				bId:document.location.href.split('?')[1].split('=')[1],
				eng:english,
				cn:china,
				shrt:short
			},
			success:function(res){
				if(res.code == 200){
					// alert('添加成功');
					getWordList();
					$('.words-input-retrieval').val('');
					$('.words-input-short').val('');
					$('.result').empty();
				}else{
					alert('添加失败：' + res.message);
				}
			}
		})
	})
	
	$("#sheet-words").on('click','.words-output-delete',function(e){
	    // console.log(e.target.id);
	    // $("#sheet"+e.target.id).hide();
		$.ajax({
			url:'http://60.205.211.19:2119/word/delete',
			type:'GET',
			headers:{
				Authorization:sessionStorage.getItem('token')
			},
			xhrFields:{
				withCredentials:true
			},
			data:{
				bId:document.location.href.split('?')[1].split('=')[1],
				wId:bill.words[this.id].id
			},
			success:function(res){
				if(res.code == 200){
					// alert('删除成功');
					getWordList();
				}else{
					alert('删除失败：' + res.message);
				}
			}
		})
	})
	
	
	$(document).ready(function(){
		$('.result').hide();
		
		$("input").focus(function(){
		    this.select();
		})
		
		//校验访问权限
		$.ajax({
			url:'http://60.205.211.19:2119/bill/checkUserBill',
			type:'GET',
			data:{
				bId:document.location.href.split('?')[1].split('=')[1]
			},
			headers:{
				Authorization:sessionStorage.getItem('token')
			},
			xhrFields:{
				withCredentials:true
			},
			async:false,
			success:function(res){
				if(res.code != 200 || !res.data){
					alert('您无权访问该词典的编辑模式');
					window.history.back();
				}
			}
		})
		
		//校验用户信息
		$.ajax({
			url:'http://60.205.211.19:2119/user/loginInfo',
			headers:{
				Authorization:sessionStorage.getItem('token')
			},
			xhrFields:{
				withCredentials:true
			},
			async:false,
			success:function(res){
				// console.log(res);
				if(res.code == 200){
					$('.second-line-admin-name').text(res.data.nickname);
					$('.option-homepage').show();
					$('.option-logout').show();
					$('.second-line-admin-pic').css('background-color','rgb(' + res.data.icon + ')');
				}else{
					$('.second-line-admin-pic').hide();
					$('.second-line-admin-name').text('【未登录】');
				}
			}
		})
	})
</script>